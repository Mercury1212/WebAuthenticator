<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Authenticator — Argon2id encrypted</title>

<!-- Use a bundled Argon2 so wasm loads reliably -->
<script src="https://cdn.jsdelivr.net/npm/argon2-browser/dist/argon2-bundled.min.js"></script>

<!-- QR Code library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#2dd4bf;
    --danger:#ff6b6b; --success:#4ade80;
    --glass: rgba(255,255,255,0.03);
    --transition: all 0.2s ease;
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    background: linear-gradient(180deg,#021027 0%, #07132a 100%);
    color:#e6eef6; display:flex; align-items:center; justify-content:center;
    padding:20px;
    box-sizing: border-box;
  }
  .wrapper{
    width:700px; 
    max-width:96vw;
    box-sizing: border-box;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:18px;
    padding: 0 12px;
    box-sizing: border-box;
  }
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px}
  
  /* Enhanced button styles */
  button{
    background:var(--glass);
    border:1px solid rgba(255,255,255,0.06);
    color:inherit;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    outline: none;
    white-space: nowrap;
  }
  button::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.3);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }
  button:focus:not(:active)::after {
    animation: ripple 0.6s ease-out;
  }
  @keyframes ripple {
   0% {
      transform: scale(0, 0);
      opacity: 0.5;
    }
    20% {
      transform: scale(10, 10);
      opacity: 0.3;
    }
    100% {
      transform: scale(35, 35);
      opacity: 0;
    }
  }
  button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border-color: rgba(255,255,255,0.1);
  }
  button:active {
    transform: translateY(1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  button.primary{
    background:linear-gradient(90deg,#06313a,#044b56);
    box-shadow:0 4px 12px rgba(2,6,23,0.6);
    border:none;
  }
  button.primary:hover {
    background:linear-gradient(90deg,#07444f,#06606d);
    box-shadow:0 6px 16px rgba(2,6,23,0.7);
  }
  button.danger{
    background:linear-gradient(90deg,#441111,#661111);
    border:none;
  }
  button.danger:hover {
    background:linear-gradient(90deg,#551111,#771111);
  }
  button.success {
    background:linear-gradient(90deg,#114422,#116633);
    border:none;
  }
  button.success:hover {
    background:linear-gradient(90deg,#225533,#227744);
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
  }
  
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); 
    padding:20px;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(2,6,23,0.6); 
    border:1px solid rgba(255,255,255,0.03);
    transition: var(--transition);
    box-sizing: border-box;
    height: 100%;
    overflow: hidden;
  }
  .card:hover {
    box-shadow:0 8px 24px rgba(2,6,23,0.7);
    border-color: rgba(255,255,255,0.05);
  }
  
  .entry{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px;
    border-radius:10px;
    margin-bottom:8px;
    background:rgba(255,255,255,0.01);
    border:1px solid rgba(255,255,255,0.02);
    transition: var(--transition);
    cursor: pointer;
    box-sizing: border-box;
  }
  .entry:hover {
    background:rgba(255,255,255,0.03);
    border-color: rgba(255,255,255,0.05);
    transform: translateX(2px);
  }
  .entry.selected {
    background:rgba(45, 212, 191, 0.08);
    border-color: rgba(45, 212, 191, 0.2);
  }
  .entry .meta{display:flex;gap:12px;align-items:center}
  .badge{
    background:rgba(255,255,255,0.03);
    padding:6px 10px;
    border-radius:8px;
    font-weight:600;
    transition: var(--transition);
    box-sizing: border-box;
  }
  .badge.success {
    background: rgba(74, 222, 128, 0.15);
    color: #4ade80;
  }
  .badge.warning {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
  }
  .badge.danger {
    background: rgba(255, 107, 107, 0.15);
    color: #ff6b6b;
  }
  .totp{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; 
    font-size:20px; 
    letter-spacing:2px;
    font-weight: bold;
    color: var(--accent);
    min-width: 90px;
    text-align: center;
  }
  .small{font-size:12px;color:var(--muted)}
  .center{display:flex;align-items:center;justify-content:center}
  footer{
    margin-top: 16px;
    padding-top: 16px;
    color:var(--muted);
    font-size:13px;
    box-sizing: border-box;
    border-top: 1px solid rgba(255,255,255,0.03);
  }

  /* Search bar */
  .search-container {
    display: flex;
    margin-bottom: 16px;
    gap: 8px;
  }
  .search-input {
    flex: 1;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(0,0,0,0.2);
    color: inherit;
    transition: var(--transition);
    font-family: inherit;
    box-sizing: border-box;
  }
  .search-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
  }
  .search-btn {
    padding: 10px 16px;
  }
  
  /* Password input with peek button */
  .password-container {
    position: relative;
  }
  .password-input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(0,0,0,0.2);
    color: inherit;
    transition: var(--transition);
    font-family: inherit;
    box-sizing: border-box;
  }
  .password-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
  }
  .peek-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
  }
  .peek-btn:hover {
    background: rgba(255,255,255,0.05);
    color: var(--accent);
  }
  /* Prevent eye icon from moving like normal buttons */
.peek-btn:hover,
.peek-btn:active {
    transform: translateY(-50%) !important;
    box-shadow: none !important;
}

  /* modal */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(2,6,23,0.8);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:40;
    backdrop-filter: blur(4px);
    padding: 20px;
    box-sizing: border-box;
  }
  .modal{
    background:linear-gradient(180deg, #061226, #041521);
    padding:24px;
    border-radius:16px;
    max-width:520px;
    width:100%;
    border:1px solid rgba(255,255,255,0.06);
    box-shadow: 0 20px 40px rgba(2,6,23,0.8);
    animation: modalFadeIn 0.2s ease-out;
    box-sizing: border-box;
  }
  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .modal h2{margin:0 0 16px 0; font-size: 1.5rem;}
  label{
    display:block;
    font-size:13px;
    color:var(--muted);
    margin:12px 0 6px;
  }
  input[type=text], input[type=password], textarea, select{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(0,0,0,0.2);
    color:inherit;
    transition: var(--transition);
    font-family: inherit;
    box-sizing: border-box;
  }
  input[type=text]:focus, input[type=password]:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
  }
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}
  .help{
    font-size:12px;
    color:var(--muted);
    margin-top:12px; 
    line-height: 1.4;
    box-sizing: border-box;
  }

  .meter{height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden; margin-top: 8px;}
  .meter > i{display:block;height:100%; background: var(--accent); border-radius: 8px;}

  .tiny{font-size:11px;color:var(--muted)}
  .muted{color:var(--muted)}
  
  /* Progress bar animation for countdown */
  @keyframes countdownProgress {
    from { width: 100%; }
    to { width: 0%; }
  }
  .countdown-progress {
    height: 3px;
    background: var(--accent);
    border-radius: 3px;
    margin-top: 4px;
    animation: countdownProgress 30s linear infinite;
  }
  
  /* List container with fixed height and scrolling */
  .list-container {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 12px;
    padding-right: 4px;
  }
  
  /* Custom scrollbar */
  .list-container::-webkit-scrollbar {
    width: 6px;
  }
  .list-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 3px;
  }
  .list-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
  }
  .list-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  
  /* Status bar */
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }
  
  /* No results message */
  .no-results {
    text-align: center;
    padding: 30px;
    color: var(--muted);
    font-style: italic;
  }
  
  /* Collapsing bar countdown */
  .countdown-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }
  
  .countdown-bar {
    flex: 1;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
  }
  
  .countdown-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: var(--accent);
    border-radius: 3px;
    transition: width 1s linear;
  }
  
  .countdown-text {
    font-size: 12px;
    color: var(--muted);
    min-width: 40px;
    text-align: right;
  }
  
  /* CSV Import/Export styles */
  .csv-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.03);
  }
  
  .csv-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  
  @media (max-width: 600px) {
    body {
      padding: 12px;
      align-items: flex-start;
      padding-top: 20px;
    }
    .wrapper {
      max-width: 100%;
    }
    .controls {
      flex-direction: column;
      width: 100%;
    }
    .controls button {
      width: 100%;
    }
    .entry {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .entry-actions {
      width: 100%;
      display: flex;
      justify-content: space-between;
    }
    .search-container {
      flex-direction: column;
    }
    .csv-buttons {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<div class="wrapper">
  <header>
    <h1>Web Authenticator — Argon2id encrypted</h1>
    <div class="controls">
      <button id="btnCreate" class="primary">Create new DB</button>
      <button id="btnLoad">Load DB</button>
      <button id="btnSave" disabled>Save DB</button>
      <button id="btnLock" disabled>Lock</button>
    </div>
  </header>

  <div class="card">
    <div class="status-bar">
      <div>
        <div class="small">Database Status</div>
        <div id="status" class="badge">Locked — no database open</div>
      </div>
      <div>
        <button id="btnAdd" disabled>Add entry</button>
      </div>
    </div>

    <!-- Search bar -->
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Search entries..." disabled>
      <button id="searchBtn" class="search-btn" disabled>Search</button>
      <button id="clearSearchBtn" class="danger" style="display: none;">Clear</button>
    </div>

    <div class="list-container" id="entries"></div>
    
    <!-- CSV Import/Export Section -->
    <div class="csv-section">
      <div class="small">CSV Import/Export</div>
      <div class="csv-buttons">
        <button id="btnExportCSV" disabled>Export to CSV</button>
        <button id="btnImportCSV" disabled>Import from CSV</button>
      </div>
    </div>
    
    <footer>
      <div>Storage: local file only. Argon2id parameters are stored inside the encrypted file for correct re-derivation.</div>
      <div class="countdown-container">
        <div class="countdown-bar">
          <div class="countdown-fill" id="countdownBar"></div>
        </div>
        <div class="countdown-text">Refresh in: <span id="countdown">--</span>s</div>
      </div>
    </footer>
  </div>
</div>

<!-- Modals -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" id="modal">
    <!-- dynamic content -->
  </div>
</div>

<input type="file" id="fileInput" accept=".auth" style="display:none" />
<input type="file" id="csvFileInput" accept=".csv" style="display:none" />

<script>
/*
  Full Web Authenticator
  - Argon2id via argon2-browser bundled
  - AES-GCM encryption for DB
  - TOTP using WebCrypto HMAC-SHA1
  - Save/Load via file download/upload
  - CSV Import/Export functionality
*/

/* ---------- Utilities ---------- */
const u8ToB64 = u8 => btoa(String.fromCharCode(...u8));
const b64ToU8 = b64 => Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
const strToU8 = s => new TextEncoder().encode(s);
const u8ToStr = u8 => new TextDecoder().decode(u8);

function randBytes(n){ return crypto.getRandomValues(new Uint8Array(n)); }
function nowUnix(){ return Math.floor(Date.now() / 1000); }

/* Base32 decode (RFC4648, no padding required) */
function base32Decode(s){
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
  s = s.replace(/=+$/,'').replace(/\s+/g,'').toUpperCase();
  let bits = 0, value = 0;
  const bytes = [];
  for(let i=0;i<s.length;i++){
    const idx = alphabet.indexOf(s[i]);
    if(idx === -1) continue;
    value = (value << 5) | idx;
    bits += 5;
    if(bits >= 8){
      bits -= 8;
      bytes.push((value >> bits) & 0xFF);
    }
  }
  return new Uint8Array(bytes);
}

/* TOTP: HMAC-SHA1 counter -> code */
async function hotp(secretBytes, counter, digits=6){
  const counterBytes = new Uint8Array(8);
  let c = BigInt(counter);
  for(let i=7;i>=0;i--){ counterBytes[i] = Number(c & 0xFFn); c >>= 8n; }
  const key = await crypto.subtle.importKey('raw', secretBytes, {name:'HMAC', hash:'SHA-1'}, false, ['sign']);
  const sig = new Uint8Array(await crypto.subtle.sign('HMAC', key, counterBytes));
  const offset = sig[sig.length - 1] & 0x0f;
  const bin = ((sig[offset] & 0x7f) << 24) | (sig[offset+1] << 16) | (sig[offset+2] << 8) | (sig[offset+3]);
  const code = (bin % (10 ** digits)).toString().padStart(digits, '0');
  return code;
}

async function totpForSecret(base32Secret, period=30, digits=6){
  const secretBytes = base32Decode(base32Secret);
  const t = Math.floor(Date.now() / 1000 / period);
  return hotp(secretBytes, BigInt(t), digits);
}

/* ---------- QR Code Generation ---------- */
function generateQRCode(url, width = 200, height = 200) {
  return new Promise((resolve, reject) => {
    const canvas = document.createElement('canvas');
    QRCode.toCanvas(canvas, url, { 
      width: width,
      height: height,
      margin: 1,
      color: {
        dark: '#000000',
        light: '#ffffff'
      }
    }, function(error) {
      if (error) {
        reject(error);
      } else {
        resolve(canvas.toDataURL('image/png'));
      }
    });
  });
}

function showQRCode(entry) {
  const otpauthUrl = `otpauth://totp/${encodeURIComponent(entry.issuer || entry.label)}:${encodeURIComponent(entry.label)}?secret=${entry.secret}&issuer=${encodeURIComponent(entry.issuer || entry.label)}&digits=${entry.digits}&period=${entry.period}`;
  
  showModal(`
    <h2>QR Code for ${escapeHtml(entry.issuer || entry.label)}</h2>
    <div class="center" style="margin: 20px 0;">
      <div id="qrCodeContainer" style="width: 200px; height: 200px; display: flex; align-items: center; justify-content: center;">
        <div class="small muted">Generating QR code...</div>
      </div>
    </div>
    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin: 10px 0;">
      <div class="small muted">Secret: ${entry.secret}</div>
      <div class="small muted">OTPAuth URL:</div>
      <div class="small" style="word-break: break-all; margin-top: 5px;">${otpauthUrl}</div>
    </div>
    <div class="actions">
      <button id="qrClose">Close</button>
    </div>
  `);
  
  // Generate the QR code after the modal is shown
  setTimeout(() => {
    generateQRCode(otpauthUrl).then(dataUrl => {
      document.getElementById('qrCodeContainer').innerHTML = `<img src="${dataUrl}" alt="QR Code" style="max-width: 100%; height: auto;" />`;
    }).catch(err => {
      console.error('QR code generation failed:', err);
      document.getElementById('qrCodeContainer').innerHTML = `<div class="small danger">Failed to generate QR code</div>`;
    });
  }, 100);
  
  modalEl.querySelector('#qrClose').onclick = closeModal;
}

/* ---------- Argon2id + AES helpers ---------- */
async function deriveKeyArgon2(password, saltBytes, params){
  // argon2-browser hash expects strings for pass and salt; convert salt bytes to string
  const passStr = password;
  const saltStr = Array.from(saltBytes).map(b=>String.fromCharCode(b)).join('');
  try{
    const argObj = await argon2.hash({
      pass: passStr,
      salt: saltStr,
      time: params.time || 3,
      mem: params.mem || 65536,
      parallelism: params.parallelism || 1,
      hashLen: params.hashLen || 32,
      type: argon2.ArgonType.Argon2id
    });
    // argObj.hash is Uint8Array
    return crypto.subtle.importKey('raw', argObj.hash, 'AES-GCM', false, ['encrypt','decrypt']);
  } catch(err){
    console.error('Argon2 error', err);
    throw err;
  }
}

async function aesGcmEncrypt(key, plaintextBytes, iv){
  return new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, plaintextBytes));
}
async function aesGcmDecrypt(key, ciphertextBytes, iv){
  return new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ciphertextBytes));
}

/* ---------- App state ---------- */
let db = { entries: [] }; // decrypted db (plain object)
let cryptoKey = null; // CryptoKey derived from Argon2
let currentFileMeta = null; // for saving: object with salt, params, etc
let totpInterval = null;
let selectedId = null;
let searchQuery = ''; // Current search query
let filteredEntries = []; // Filtered entries based on search
let isAutoSaving = false; // Flag to prevent multiple auto-saves

/* ---------- DOM ---------- */
const btnCreate = document.getElementById('btnCreate');
const btnLoad = document.getElementById('btnLoad');
const btnSave = document.getElementById('btnSave');
const btnLock = document.getElementById('btnLock');
const btnAdd = document.getElementById('btnAdd');
const btnExportCSV = document.getElementById('btnExportCSV');
const btnImportCSV = document.getElementById('btnImportCSV');
const entriesEl = document.getElementById('entries');
const statusEl = document.getElementById('status');
const countdownEl = document.getElementById('countdown');
const countdownBar = document.getElementById('countdownBar');
const fileInput = document.getElementById('fileInput');
const csvFileInput = document.getElementById('csvFileInput');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalEl = document.getElementById('modal');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearchBtn = document.getElementById('clearSearchBtn');

/* ---------- UI helpers ---------- */
function showModal(html){
  modalEl.innerHTML = html;
  modalBackdrop.style.display = 'flex';
  
  // Add peek functionality to password fields
  setTimeout(() => {
    const passwordInputs = modalEl.querySelectorAll('input[type="password"]');
    passwordInputs.forEach(input => {
      // Create container
      const container = document.createElement('div');
      container.className = 'password-container';
      
      // Wrap the input
      input.parentNode.insertBefore(container, input);
      container.appendChild(input);
      
      // Add peek button
      const peekBtn = document.createElement('button');
      peekBtn.className = 'peek-btn';
      peekBtn.innerHTML = '👁';
      peekBtn.type = 'button';
      peekBtn.title = 'Show password';
      
      peekBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        input.type = 'text';
        peekBtn.innerHTML = '👁‍🗨';
        peekBtn.title = 'Hide password';
      });
      
      peekBtn.addEventListener('mouseup', (e) => {
        e.preventDefault();
        input.type = 'password';
        peekBtn.innerHTML = '👁';
        peekBtn.title = 'Show password';
      });
      
      peekBtn.addEventListener('mouseleave', (e) => {
        input.type = 'password';
        peekBtn.innerHTML = '👁';
        peekBtn.title = 'Show password';
      });
      
      // For touch devices
      peekBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        input.type = 'text';
        peekBtn.innerHTML = '👁‍🗨';
        peekBtn.title = 'Hide password';
      });
      
      peekBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        input.type = 'password';
        peekBtn.innerHTML = '👁';
        peekBtn.title = 'Show password';
      });
      
      container.appendChild(peekBtn);
    });
  }, 10);
  
  const fi = modalEl.querySelector('input,textarea,select,button');
  if(fi) fi.focus();
}

function closeModal(){ modalBackdrop.style.display = 'none'; modalEl.innerHTML = ''; }

modalBackdrop.addEventListener('click', (e)=>{
  if(e.target === modalBackdrop) closeModal();
});

/* close on Escape */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') closeModal();
});

/* ---------- App functions ---------- */

function setLockedUI(locked){
  btnSave.disabled = locked;
  btnAdd.disabled = locked;
  btnLock.disabled = locked;
  btnExportCSV.disabled = locked;
  btnImportCSV.disabled = locked;
  searchInput.disabled = locked;
  searchBtn.disabled = locked;
  
  if(locked){
    statusEl.textContent = 'Locked — no database open';
    statusEl.className = 'badge';
    clearSearch();
  } else {
    statusEl.textContent = `Unlocked — ${db.entries.length} entries`;
    statusEl.className = 'badge success';
    searchInput.disabled = false;
    searchBtn.disabled = false;
    btnExportCSV.disabled = false;
    btnImportCSV.disabled = false;
  }
  renderEntries();
}

function filterEntries(query) {
  if (!query.trim()) {
    filteredEntries = [...db.entries];
    return;
  }
  
  const lowerQuery = query.toLowerCase();
  filteredEntries = db.entries.filter(entry => 
    entry.label.toLowerCase().includes(lowerQuery) || 
    (entry.issuer && entry.issuer.toLowerCase().includes(lowerQuery)) ||
    entry.secret.toLowerCase().includes(lowerQuery)
  );
}

function renderEntries(){
  entriesEl.innerHTML = '';
  
  // Use filtered entries if search is active, otherwise use all entries
  const entriesToRender = searchQuery ? filteredEntries : db.entries;
  
  if(!db || !db.entries || db.entries.length === 0){
    entriesEl.innerHTML = '<div class="muted tiny" style="text-align: center; padding: 40px;">No entries yet. Click "Add entry" to get started.</div>';
    return;
  }
  
  if(entriesToRender.length === 0){
    entriesEl.innerHTML = '<div class="no-results">No entries found matching your search.</div>';
    return;
  }
  
  entriesToRender.forEach((e, idx)=>{
    // Find the original index in the db.entries array
    const originalIndex = db.entries.findIndex(entry => 
      entry.label === e.label && entry.secret === e.secret
    );
    
    const div = document.createElement('div');
    div.className = 'entry' + (selectedId === originalIndex ? ' selected' : '');
    
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<div>
      <div style="font-weight:700">${escapeHtml(e.issuer ? e.issuer : e.label)}</div>
      <div class="small muted">${escapeHtml(e.label)}</div>
    </div>`;
    
    const right = document.createElement('div');
    right.style.display='flex'; 
    right.style.gap='12px'; 
    right.style.alignItems='center';
    
    const totpSpan = document.createElement('div');
    totpSpan.className='totp';
    totpSpan.textContent = '------';
    totpSpan.id = 'totp-'+originalIndex;
    
    const ctr = document.createElement('div');
    ctr.className = 'entry-actions';
    ctr.style.display='flex'; 
    ctr.style.gap='6px';
    
    const btnCopy = document.createElement('button'); 
    btnCopy.textContent='Copy'; 
    btnCopy.title='Copy code to clipboard';
    
    const btnQR = document.createElement('button');
    btnQR.textContent = 'QR';
    btnQR.title = 'Show QR Code';
    
    const btnEdit = document.createElement('button'); 
    btnEdit.textContent='Edit';
    
    const btnDel = document.createElement('button'); 
    btnDel.textContent='Delete'; 
    btnDel.className = 'danger';
    
    // Copy code functionality
    btnCopy.onclick = async ()=>{
      const code = await totpForSecret(e.secret, e.period, e.digits);
      try{
        await navigator.clipboard.writeText(code);
        // Visual feedback
        btnCopy.textContent = '✓ Copied!';
        btnCopy.classList.add('success');
        setTimeout(() => {
          btnCopy.textContent = 'Copy';
          btnCopy.classList.remove('success');
        }, 2000);
      }catch(err){
        alert('Copy failed — allow clipboard permissions or copy manually: ' + code);
      }
    };
    
    // QR code functionality
    btnQR.onclick = () => { showQRCode(e); };
    
    btnEdit.onclick = ()=>{ openEditModal(originalIndex); };
    btnDel.onclick = ()=>{ if(confirm('Delete this entry?')){ 
      db.entries.splice(originalIndex, 1); 
      filterEntries(searchQuery);
      renderEntries(); 
      setLockedUI(false); 
    }};
    
    ctr.appendChild(btnCopy);
    ctr.appendChild(btnQR);
    ctr.appendChild(btnEdit);
    ctr.appendChild(btnDel);
    
    right.appendChild(totpSpan);
    right.appendChild(ctr);
    
    div.appendChild(meta);
    div.appendChild(right);
    
    entriesEl.appendChild(div);
  });
}

function clearSearch() {
  searchQuery = '';
  searchInput.value = '';
  filteredEntries = [...db.entries];
  clearSearchBtn.style.display = 'none';
  renderEntries();
}

function performSearch() {
  searchQuery = searchInput.value;
  filterEntries(searchQuery);
  renderEntries();
  
  // Show clear button if there's a search query
  if (searchQuery) {
    clearSearchBtn.style.display = 'block';
  } else {
    clearSearchBtn.style.display = 'none';
  }
}

/* ---------- CSV Import/Export Functions ---------- */
function exportToCSV() {
  if (!db.entries || db.entries.length === 0) {
    alert('No entries to export');
    return;
  }
  
  // Create CSV content
  let csvContent = 'issuer,label,secret,digits,period\n';
  
  db.entries.forEach(entry => {
    const issuer = escapeCSVField(entry.issuer || '');
    const label = escapeCSVField(entry.label);
    const secret = escapeCSVField(entry.secret);
    const digits = entry.digits || 6;
    const period = entry.period || 30;
    
    csvContent += `${issuer},${label},${secret},${digits},${period}\n`;
  });
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  const date = new Date().toISOString().slice(0, 10);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `authenticator-backup-${date}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Add visual feedback for successful export
  const btn = document.getElementById('btnExportCSV');
  const originalText = btn.textContent;
  btn.textContent = '✓ Exported!';
  btn.classList.add('success');
  setTimeout(() => {
    btn.textContent = originalText;
    btn.classList.remove('success');
  }, 2000);
}

function escapeCSVField(field) {
  if (field.includes(',') || field.includes('"') || field.includes('\n')) {
    return `"${field.replace(/"/g, '""')}"`;
  }
  return field;
}

function importFromCSV() {
  csvFileInput.click();
}

function handleCSVImport(file) {
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const csvContent = e.target.result;
      const lines = csvContent.split('\n');
      const newEntries = [];
      
      // Skip header row and process each line
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const values = parseCSVLine(line);
        if (values.length < 3) continue; // Need at least issuer, label, secret
        
        const issuer = values[0] || '';
        const label = values[1] || '';
        const secret = values[2].replace(/\s+/g, '').toUpperCase();
        const digits = parseInt(values[3] || '6', 10);
        const period = parseInt(values[4] || '30', 10);
        
        if (label && secret) {
          newEntries.push({
            issuer,
            label,
            secret,
            digits: isNaN(digits) ? 6 : digits,
            period: isNaN(period) ? 30 : period
          });
        }
      }
      
      if (newEntries.length === 0) {
        alert('No valid entries found in the CSV file');
        return;
      }
      
      // Show import confirmation modal
      showModal(`
        <h2>Import CSV Entries</h2>
        <p>Found ${newEntries.length} valid entries in the CSV file.</p>
        <div style="max-height: 200px; overflow-y: auto; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
          ${newEntries.map(e => `<div class="small">${escapeHtml(e.issuer || e.label)}: ${escapeHtml(e.label)}</div>`).join('')}
        </div>
        <label>
          <input type="checkbox" id="importOverwrite" />
          Overwrite existing entries with same label
        </label>
        <div class="actions">
          <button id="importCancel">Cancel</button>
          <button id="importConfirm" class="primary">Import ${newEntries.length} Entries</button>
        </div>
      `);
      
      modalEl.querySelector('#importCancel').onclick = closeModal;
      modalEl.querySelector('#importConfirm').onclick = () => {
        const overwrite = modalEl.querySelector('#importOverwrite').checked;
        processCSVImport(newEntries, overwrite);
        closeModal();
      };
      
    } catch (error) {
      console.error('CSV import error:', error);
      alert('Failed to parse CSV file: ' + error.message);
    }
  };
  
  reader.onerror = function() {
    alert('Failed to read the CSV file');
  };
  
  reader.readAsText(file);
}

function parseCSVLine(line) {
  const values = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    
    if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      values.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  
  values.push(current);
  return values.map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"').trim());
}

function processCSVImport(newEntries, overwrite) {
  if (overwrite) {
    // Remove existing entries with same labels
    const labelsToImport = new Set(newEntries.map(e => e.label.toLowerCase()));
    db.entries = db.entries.filter(e => !labelsToImport.has(e.label.toLowerCase()));
  }
  
  // Add new entries
  db.entries.push(...newEntries);
  
  // Update UI
  setLockedUI(false);
  renderEntries();
  
  alert(`Successfully imported ${newEntries.length} entries`);
}

/* ---------- Add / Edit ---------- */
function openAddModal(){
  showModal(`
    <h2>Create new entry</h2>
    <label>Label (account)</label>
    <input id="m_label" type="text" placeholder="email@example.com" />
    <label>Issuer (provider)</label>
    <input id="m_issuer" type="text" placeholder="GitHub, Google, ..."/>
    <label>Secret (Base32)</label>
    <input id="m_secret" type="text" placeholder="JBSWY3DPEHPK3PXP"/>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Digits</label>
        <select id="m_digits"><option>6</option><option>8</option></select>
      </div>
      <div>
        <label>Period (sec)</label>
        <select id="m_period"><option>30</option><option>60</option></select>
      </div>
    </div>
    <div class="actions">
      <button id="m_cancel">Cancel</button>
      <button id="m_save" class="primary">Save</button>
    </div>
  `);
  modalEl.querySelector('#m_cancel').onclick = closeModal;
  modalEl.querySelector('#m_save').onclick = ()=>{
    const label = modalEl.querySelector('#m_label').value.trim();
    const issuer = modalEl.querySelector('#m_issuer').value.trim();
    const secret = modalEl.querySelector('#m_secret').value.trim().replace(/\s+/g,'').toUpperCase();
    const digits = parseInt(modalEl.querySelector('#m_digits').value,10);
    const period = parseInt(modalEl.querySelector('#m_period').value,10);
    if(!label || !secret){ alert('Label and secret required'); return; }
    db.entries.push({label, issuer, secret, digits, period});
    closeModal();
    setLockedUI(false);
    // After adding, update search if active
    if (searchQuery) {
      filterEntries(searchQuery);
      renderEntries();
    }
  };
}

function openEditModal(idx){
  const e = db.entries[idx];
  showModal(`
    <h2>Edit entry</h2>
    <label>Label (account)</label>
    <input id="m_label" type="text" value="${escapeHtml(e.label)}" />
    <label>Issuer (provider)</label>
    <input id="m_issuer" type="text" value="${escapeHtml(e.issuer||'')}" />
    <label>Secret (Base32)</label>
    <input id="m_secret" type="text" value="${escapeHtml(e.secret)}"/>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Digits</label>
        <select id="m_digits"><option${e.digits==6?' selected':''}>6</option><option${e.digits==8?' selected':''}>8</option></select>
      </div>
      <div>
        <label>Period (sec)</label>
        <select id="m_period"><option${e.period==30?' selected':''}>30</option><option${e.period==60?' selected':''}>60</option></select>
      </div>
    </div>
    <div class="actions">
      <button id="m_cancel">Cancel</button>
      <button id="m_save" class="primary">Save</button>
    </div>
  `);
  modalEl.querySelector('#m_cancel').onclick = closeModal;
  modalEl.querySelector('#m_save').onclick = ()=>{
    const label = modalEl.querySelector('#m_label').value.trim();
    const issuer = modalEl.querySelector('#m_issuer').value.trim();
    const secret = modalEl.querySelector('#m_secret').value.trim().replace(/\s+/g,'').toUpperCase();
    const digits = parseInt(modalEl.querySelector('#m_digits').value,10);
    const period = parseInt(modalEl.querySelector('#m_period').value,10);
    if(!label || !secret){ alert('Label and secret required'); return; }
    db.entries[idx] = {label, issuer, secret, digits, period};
    closeModal();
    setLockedUI(false);
    // After editing, update search if active
    if (searchQuery) {
      filterEntries(searchQuery);
      renderEntries();
    }
  };
}

/* ---------- Create DB / Lock / Save / Load ---------- */

btnCreate.addEventListener('click', async ()=>{
  showModal(`
    <h2>Create new database</h2>
    <label>Master password</label>
    <div class="password-container">
      <input id="p1" type="password" placeholder="Enter password" />
    </div>
    <label>Confirm password</label>
    <div class="password-container">
      <input id="p2" type="password" placeholder="Confirm password" />
    </div>
    <label>Argon2id parameters (you can leave defaults)</label>
    <div class="row">
      <div><label>Time (iterations)</label><input id="p_time" type="text" value="3" /></div>
      <div><label>Memory (KiB)</label><input id="p_mem" type="text" value="65536" /></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>Parallelism</label><input id="p_par" type="text" value="1" /></div>
      <div><label>HashLen (bytes)</label><input id="p_hashlen" type="text" value="32" /></div>
    </div>
    <div class="actions">
      <button id="c_cancel">Cancel</button>
      <button id="c_create" class="primary">Create</button>
    </div>
  `);
  modalEl.querySelector('#c_cancel').onclick = closeModal;
  modalEl.querySelector('#c_create').onclick = async ()=>{
    const p1 = modalEl.querySelector('#p1').value;
    const p2 = modalEl.querySelector('#p2').value;
    if(p1 !== p2){ alert('Passwords do not match'); return; }
    if(!p1){ alert('Password required'); return; }
    const params = {
      time: parseInt(modalEl.querySelector('#p_time').value||'3',10),
      mem: parseInt(modalEl.querySelector('#p_mem').value||'65536',10),
      parallelism: parseInt(modalEl.querySelector('#p_par').value||'1',10),
      hashLen: parseInt(modalEl.querySelector('#p_hashlen').value||'32',10)
    };
    const salt = randBytes(16);
    try{
      cryptoKey = await deriveKeyArgon2(p1, salt, params);
    }catch(err){
      alert('Argon2 derivation failed: '+err);
      console.error(err);
      return;
    }
    db = { entries: [] , createdAt: new Date().toISOString() };
    currentFileMeta = { salt: u8ToB64(salt), params, version:1 };
    closeModal();
    setLockedUI(false);
    alert('Database created. Please Save DB to a file to store it locally.');
  };
});

btnAdd.addEventListener('click', ()=> openAddModal());

btnLock.addEventListener('click', ()=>{
  if(!cryptoKey){
    return;
  }
  if(confirm('Lock and clear decrypted DB from memory?')){
    cryptoKey = null;
    db = { entries: [] };
    currentFileMeta = null;
    selectedId = null;
    setLockedUI(true);
    if(totpInterval){ clearInterval(totpInterval); totpInterval=null; countdownEl.textContent='--'; }
  }
});

btnSave.addEventListener('click', async ()=>{
  if(!cryptoKey || !currentFileMeta){ alert('No unlocked database to save'); return; }
  const plaintext = strToU8(JSON.stringify(db));
  const iv = randBytes(12);
  try{
    const ct = await aesGcmEncrypt(cryptoKey, plaintext, iv);
    
    // Create the payload object
    const payload = {
      meta: currentFileMeta,
      iv: u8ToB64(iv),
      ciphertext: u8ToB64(ct)
    };
    
    // Convert the entire payload to a JSON string and then to Base64
    const payloadString = JSON.stringify(payload);
    const payloadBase64 = btoa(unescape(encodeURIComponent(payloadString)));
    
    const blob = new Blob([payloadBase64], {type: 'text/plain'});
    const filename = `authenticator-${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.auth`;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    
    // Add visual feedback for successful save
    const btn = document.getElementById('btnSave');
    const originalText = btn.textContent;
    btn.textContent = '✓ Saved!';
    btn.classList.add('success');
    setTimeout(() => {
      btn.textContent = originalText;
      btn.classList.remove('success');
    }, 2000);
  } catch(err){
    console.error(err);
    alert('Encryption failed: '+err);
  }
});

btnLoad.addEventListener('click', ()=> fileInput.click());

fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try{
    const base64Content = await f.text();
    
    // Decode the Base64 content back to JSON
    try {
      const jsonString = decodeURIComponent(escape(atob(base64Content)));
      let parsed = JSON.parse(jsonString);
      
      if(!parsed.meta || !parsed.iv || !parsed.ciphertext){ 
        alert('Invalid DB file'); 
        fileInput.value=''; 
        return; 
      }
      
      showModal(`
        <h2>Unlock database</h2>
        <label>Master password</label>
        <div class="password-container">
          <input id="load_pw" type="password" placeholder="Enter master password" />
        </div>
        <div class="actions">
          <button id="l_cancel">Cancel</button>
          <button id="l_open" class="primary">Open</button>
        </div>
      `);
      
      modalEl.querySelector('#l_cancel').onclick = ()=>{
        fileInput.value='';
        closeModal();
      };
      
      modalEl.querySelector('#l_open').onclick = async ()=>{
        const pw = modalEl.querySelector('#load_pw').value;
        if(!pw){ alert('Password required'); return; }
        const salt = b64ToU8(parsed.meta.salt);
        const params = parsed.meta.params;
        try{
          const key = await deriveKeyArgon2(pw, salt, params);
          const iv = b64ToU8(parsed.iv);
          const ct = b64ToU8(parsed.ciphertext);
          const pt = await aesGcmDecrypt(key, ct, iv);
          const obj = JSON.parse(u8ToStr(pt));
          db = obj;
          cryptoKey = key;
          currentFileMeta = parsed.meta;
          closeModal();
          setLockedUI(false);
          startTotpLoop();
          alert('Database unlocked.');
        }catch(err){
          console.error(err);
          alert('Failed to unlock — wrong password or corrupted file.');
        } finally {
          fileInput.value='';
        }
      };
      
    } catch (decodeError) {
      // If Base64 decoding fails, try the old JSON format for backward compatibility
      try {
        let parsed = JSON.parse(base64Content);
        if(!parsed.meta || !parsed.iv || !parsed.ciphertext){ 
          alert('Invalid DB file'); 
          fileInput.value=''; 
          return; 
        }
        
        showModal(`
          <h2>Unlock database</h2>
          <label>Master password</label>
          <div class="password-container">
            <input id="load_pw" type="password" placeholder="Enter master password" />
          </div>
          <div class="actions">
            <button id="l_cancel">Cancel</button>
            <button id="l_open" class="primary">Open</button>
          </div>
        `);
        
        modalEl.querySelector('#l_cancel').onclick = ()=>{
          fileInput.value='';
          closeModal();
        };
        
        modalEl.querySelector('#l_open').onclick = async ()=>{
          const pw = modalEl.querySelector('#load_pw').value;
          if(!pw){ alert('Password required'); return; }
          const salt = b64ToU8(parsed.meta.salt);
          const params = parsed.meta.params;
          try{
            const key = await deriveKeyArgon2(pw, salt, params);
            const iv = b64ToU8(parsed.iv);
            const ct = b64ToU8(parsed.ciphertext);
            const pt = await aesGcmDecrypt(key, ct, iv);
            const obj = JSON.parse(u8ToStr(pt));
            db = obj;
            cryptoKey = key;
            currentFileMeta = parsed.meta;
            closeModal();
            setLockedUI(false);
            startTotpLoop();
            alert('Database unlocked.');
          }catch(err){
            console.error(err);
            alert('Failed to unlock — wrong password or corrupted file.');
          } finally {
            fileInput.value='';
          }
        };
        
      } catch (jsonError) {
        alert('Failed to read file: Invalid format');
        fileInput.value='';
      }
    }
  }catch(err){
    console.error(err);
    alert('Failed to load file: '+err);
    fileInput.value='';
  }
});

/* ---------- CSV Import/Export Event Listeners ---------- */
btnExportCSV.addEventListener('click', exportToCSV);
btnImportCSV.addEventListener('click', importFromCSV);

csvFileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    handleCSVImport(file);
  }
  csvFileInput.value = '';
});

/* ---------- TOTP loop ---------- */
function startTotpLoop(){
  if(totpInterval) clearInterval(totpInterval);
  totpInterval = setInterval(updateTotps, 1000);
  updateTotps();
}

function updateTotps(){
  if(!db || !db.entries) return;
  const now = nowUnix();
  const period = 30;
  const remaining = period - (now % period);
  
  // Update countdown text
  countdownEl.textContent = remaining;
  
  // Update collapsing bar
  const percentage = (remaining / period) * 100;
  countdownBar.style.width = percentage + '%';
  
  // Change color based on remaining time
  if (remaining <= 10) {
    countdownBar.style.background = '#fbbf24'; // warning color
  } else if (remaining <= 5) {
    countdownBar.style.background = '#ff6b6b'; // danger color
  } else {
    countdownBar.style.background = 'var(--accent)'; // normal color
  }
  
  db.entries.forEach((e, idx)=>{
    const el = document.getElementById('totp-'+idx);
    if(!el) return;
    totpForSecret(e.secret, e.period, e.digits).then(code=>{
      if(el) el.textContent = code;
    }).catch(err=>{
      console.error('TOTP error', err);
      el.textContent = 'ERROR';
    });
  });
}

/* ---------- Auto-save functionality ---------- */
function setupAutoSave() {
  window.addEventListener('beforeunload', async (e) => {
    if (cryptoKey && currentFileMeta && !isAutoSaving) {
      isAutoSaving = true;

      e.preventDefault();
      e.returnValue = 'Your database is being downloaded before reloading...';

      try {
        // Show downloading modal
        showModal(`
          <h2>Downloading Database</h2>
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">⏳</div>
            <p>Your database is being downloaded before the page reloads.</p>
            <p>Please wait...</p>
          </div>
        `);

        await autoSaveDb();

        delete e.returnValue;

        setTimeout(() => {
          closeModal();
        }, 500);
      } catch (err) {
        console.error('Auto-save failed:', err);
        delete e.returnValue;
        closeModal();
      }

      // ✅ Reset flag if reload was canceled
      setTimeout(() => {
        isAutoSaving = false;
      }, 0);
    }
  });
}


async function autoSaveDb() {
  if (!cryptoKey || !currentFileMeta) return;
  
  try {
    const plaintext = strToU8(JSON.stringify(db));
    const iv = randBytes(12);
    const ct = await aesGcmEncrypt(cryptoKey, plaintext, iv);
    
    // Create the payload object
    const payload = {
      meta: currentFileMeta,
      iv: u8ToB64(iv),
      ciphertext: u8ToB64(ct)
    };
    
    // Convert the entire payload to a JSON string and then to Base64
    const payloadString = JSON.stringify(payload);
    const payloadBase64 = btoa(unescape(encodeURIComponent(payloadString)));
    
    const blob = new Blob([payloadBase64], {type: 'text/plain'});
    const filename = `authenticator-backup-${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.auth`;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    
    // Wait a moment for the download to start
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // Clean up
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    
    console.log('Database auto-saved successfully');
  } catch (err) {
    console.error('Auto-save failed:', err);
    throw err;
  }
}

/* ---------- Init ---------- */
function escapeHtml(s){ return s ? s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

setLockedUI(true);

// Add ripple effect to all buttons
document.addEventListener('mousedown', function(e) {
  const target = e.target.closest('button');
  if (!target) return;
  
  const rect = target.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  const ripple = document.createElement('span');
  ripple.classList.add('ripple');
  ripple.style.left = x + 'px';
  ripple.style.top = y + 'px';
  target.appendChild(ripple);
  
  setTimeout(() => {
    ripple.remove();
  }, 600);
});

// Search functionality
searchBtn.addEventListener('click', performSearch);
clearSearchBtn.addEventListener('click', clearSearch);

// Allow pressing Enter to search
searchInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    performSearch();
  }
});

// Enable search when database is unlocked
setInterval(() => {
  if (cryptoKey) {
    searchInput.disabled = false;
    searchBtn.disabled = false;
  }
}, 1000);

// Setup auto-save on page reload
setupAutoSave();

</script>
</body>
</html>
